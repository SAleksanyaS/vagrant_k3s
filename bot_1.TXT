import logging
from dialog_bot_sdk.bot import DialogBot
from dialog_bot_sdk.entities.messaging import MessageHandler, MessageContentType, CommandHandler
from config.config import BOT_ENDPOINT, BOT_TOKEN, logger

class SberBot:
    def __init__(self):
        # Создаем защищённый бот
        self.bot = DialogBot.get_secure_bot(BOT_ENDPOINT, BOT_TOKEN)
        logger.info("Бот инициализирован (endpoint: %s)", BOT_ENDPOINT)

    def on_message(self, func):
        # Регистрируем обработчик текстовых сообщений
        self.bot.messaging.message_handler([
            MessageHandler(func, MessageContentType.TEXT_MESSAGE)
        ])

    def on_command(self, command: str, description: str):
        def decorator(func):
            self.bot.messaging.command_handler([
                CommandHandler(func, command, description=description)
            ])
            return func
        return decorator

    def send_message(self, peer, text, attachments=None):
        self.bot.messaging.send_message(peer, text, attachments=attachments)

    def start_polling(self):
        self.bot.updates.on_updates(
            do_read_message=True,
            do_register_commands=True
        )

# Создаём один глобальный объект sber_bot, чтобы использовать в других файлах
sber_bot = SberBot()
