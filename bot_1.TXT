–ü—Ä–æ–µ–∫—Ç —á–∞—Ç-–±–æ—Ç–∞ –Ω–∞ SberChat (Dialog) —Å —á–∏—Å—Ç–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π
–ù–∏–∂–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω –ø—Ä–∏–º–µ—Ä –ø–æ–ª–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ —á–∞—Ç-–±–æ—Ç–∞ –Ω–∞ Python —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º SDK –°–±–µ—Ä—á–∞—Ç–∞ (Dialog Bot SDK) –∏ –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤ —á–∏—Å—Ç–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã. –ë–æ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ @rmoc –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö, –æ—Ç–≤–µ—á–∞–µ—Ç –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π (Excel), –ø—Ä–∏–∫—Ä–µ–ø–ª—è–µ—Ç –∫–Ω–æ–ø–∫–∏ ¬´–õ–∞–π–∫¬ª/¬´–î–∏–∑–ª–∞–π–∫¬ª –∏ –ª–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è.
–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏ –∑–∞–ø—É—Å–∫
–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Python 3.10 –∏ —Å–æ–∑–¥–∞–π—Ç–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ (venv).
–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏:
bash
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
pip install dialog-bot-sdk grpcio openpyxl pandas python-dotenv
dialog-bot-sdk ‚Äì SDK –¥–ª—è –°–±–µ—Ä—á–∞—Ç–∞ (Dialog Messenger).
grpcio ‚Äì –Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è —Ä–∞–±–æ—Ç—ã SDK (–≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å dialog-bot-sdk).
openpyxl –∏ pandas ‚Äì –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Excel-—Ñ–∞–π–ª–∞–º–∏.
python-dotenv ‚Äì –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ —Ñ–∞–π–ª–∞ .env.
–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞ –∏ —É–∫–∞–∂–∏—Ç–µ –≤ –Ω—ë–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–ø—Ä–∏–º–µ—Ä):
ini
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
BOT_ENDPOINT=your_sberchat_endpoint
BOT_TOKEN=your_bot_token
SASHA_ID=123456        # ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è @sasha –¥–ª—è —É–ø–æ–º–∏–Ω–∞–Ω–∏—è
BOT_NAME=rmoc         # –Ω–∏–∫–Ω–µ–π–º –±–æ—Ç–∞ –≤ —á–∞—Ç–µ
BOT_ENDPOINT –∏ BOT_TOKEN ‚Äì –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏–∑ –∞–¥–º–∏–Ω–∫–∏ –°–±–µ—Ä—á–∞—Ç–∞ (Dialog).
SASHA_ID ‚Äì –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äúsasha‚Äù (–¥–ª—è —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø—Ä–∏ –¥–∏–∑–ª–∞–π–∫–µ).
BOT_NAME ‚Äì –Ω–∏–∫–Ω–µ–π–º –±–æ—Ç–∞ (@rmoc), —á—Ç–æ–±—ã —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞—Ç—å —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ.
–ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞: –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ .env –∑–∞–ø—É—Å—Ç–∏—Ç–µ –≥–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª:
bash
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
python main.py
–ë–æ—Ç –Ω–∞—á–Ω—ë—Ç –ø—Ä–æ—Å–ª—É—à–∏–≤–∞—Ç—å –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è.
–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
bash
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
project_root/
‚îú‚îÄ config/
‚îÇ   ‚îî‚îÄ config.py         # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îú‚îÄ domain/
‚îÇ   ‚îú‚îÄ knowledge.py      # –ü–æ–∏—Å–∫ –æ—Ç–≤–µ—Ç–æ–≤ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
‚îÇ   ‚îú‚îÄ models.py         # –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö (–≤–æ–ø—Ä–æ—Å, –∏—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞, –æ—Ç–∑—ã–≤)
‚îÇ   ‚îî‚îÄ logic.py          # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –±–æ—Ç–∞ (–ø–∞—Ä—Å–∏–Ω–≥ –≤–æ–ø—Ä–æ—Å–æ–≤)
‚îú‚îÄ infrastructure/
‚îÇ   ‚îú‚îÄ excel_repo.py     # –†–∞–±–æ—Ç–∞ —Å Excel (—á—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö)
‚îÇ   ‚îî‚îÄ sber_sdk.py       # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å SDK –°–±–µ—Ä—á–∞—Ç–∞
‚îú‚îÄ interface/
‚îÇ   ‚îî‚îÄ keyboard.py       # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
‚îú‚îÄ main.py              # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞, –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –±–æ—Ç–∞ –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
‚îî‚îÄ .env                 # –§–∞–π–ª —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π (–Ω–µ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏)
config/ ‚Äì –∑–¥–µ—Å—å —Ö—Ä–∞–Ω–∏–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ä–µ–¥—ã, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è).
domain/ ‚Äì –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö –∏ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ (–ø–æ–∏—Å–∫ –ø–æ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π, —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤).
infrastructure/ ‚Äì —Ä–∞–±–æ—Ç–∞ —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Ä–µ—Å—É—Ä—Å–∞–º–∏: —á—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å Excel, —Å–≤—è–∑—å —Å SDK –°–±–µ—Ä—á–∞—Ç–∞.
interface/ ‚Äì —Å–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (–∫–Ω–æ–ø–æ–∫).
main.py ‚Äì –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∏ –∑–∞–ø—É—Å–∫.
–û–ø–∏—Å–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö –º–æ–¥—É–ª–µ–π
1. config/config.py
–ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ä–µ–¥—ã –∏–∑ .env.
–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (–≤ —Ñ–∞–π–ª –∏ –≤ –∫–æ–Ω—Å–æ–ª—å).
–•—Ä–∞–Ω–∏—Ç –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã (–ø—É—Ç–∏ –∫ Excel, –ø–∞—Ä–∞–º–µ—Ç—Ä @rmoc –∏ —Ç.–¥.).
python
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
# config/config.py
import os
from dotenv import load_dotenv
import logging

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env
load_dotenv()

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –°–±–µ—Ä—á–∞—Ç—É (Dialog)
BOT_ENDPOINT = os.getenv("BOT_ENDPOINT")
BOT_TOKEN = os.getenv("BOT_TOKEN")
BOT_NAME = os.getenv("BOT_NAME", "rmoc")   # –ù–∏–∫ –±–æ—Ç–∞ –≤ —á–∞—Ç–µ

# ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è @sasha –¥–ª—è —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø—Ä–∏ –¥–∏–∑–ª–∞–π–∫–µ
SASHA_ID = os.getenv("SASHA_ID")

# –ü—É—Ç–∏ –∫ Excel-—Ñ–∞–π–ª–∞–º
KNOWLEDGE_FILE = "knowledge_base.xlsx"
CHAT_HISTORY_FILE = "chat_history.xlsx"
FEEDBACK_FILE = "feedback_data.xlsx"
FULL_LOG_FILE = "full_chat_log.xlsx"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
LOG_FORMAT = "%(asctime)s [%(levelname)s] %(message)s"
LOG_DATEFMT = "%Y-%m-%d %H:%M:%S"

# –°–æ–∑–¥–∞—ë–º –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º –ª–æ–≥–µ—Ä
logger = logging.getLogger("rmoc_bot")
logger.setLevel(logging.INFO)

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ñ–∞–π–ª
file_handler = logging.FileHandler("bot.log", encoding="utf-8")
file_handler.setFormatter(logging.Formatter(LOG_FORMAT, LOG_DATEFMT))
logger.addHandler(file_handler)

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–Ω—Å–æ–ª—å
console_handler = logging.StreamHandler()
console_handler.setFormatter(logging.Formatter(LOG_FORMAT, LOG_DATEFMT))
logger.addHandler(console_handler)

logger.info("–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞: BOT_ENDPOINT=%s, BOT_NAME=%s", BOT_ENDPOINT, BOT_NAME)
–≠—Ç–æ—Ç –º–æ–¥—É–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ. –§–∞–π–ª bot.log –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—à–∏–±–∫–∞—Ö –∏ –¥–µ–π—Å—Ç–≤–∏—è—Ö –±–æ—Ç–∞.
2. domain/models.py
–ó–¥–µ—Å—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å dataclass –∏–ª–∏ –ø—Ä–æ—Å—Ç—ã–µ –∫–ª–∞—Å—Å—ã):
python
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
# domain/models.py
from dataclasses import dataclass
from datetime import datetime

@dataclass
class QAPair:
    """–ü–æ–∑–∏—Ü–∏—è –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π: –≤–æ–ø—Ä–æ—Å –∏ –æ—Ç–≤–µ—Ç."""
    question: str
    answer: str

@dataclass
class ChatEntry:
    """–ó–∞–ø–∏—Å—å –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞: –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –æ—Ç–≤–µ—Ç –±–æ—Ç–∞, –≤—Ä–µ–º—è."""
    user: str
    question: str
    answer: str
    timestamp: datetime

@dataclass
class FeedbackEntry:
    """–î–∞–Ω–Ω—ã–µ –æ—Ç–∑—ã–≤–∞: –≤–æ–ø—Ä–æ—Å, –æ—Ç–≤–µ—Ç, —Ç–∏–ø –æ—Ç–∑—ã–≤–∞, –≤—Ä–µ–º—è."""
    user: str
    question: str
    answer: str
    feedback: str      # "like" –∏–ª–∏ "dislike"
    timestamp: datetime

@dataclass
class FullLogEntry:
    """–ü–æ–ª–Ω—ã–π –ª–æ–≥: –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–∑–∞–ø—Ä–æ—Å/–æ—Ç–≤–µ—Ç/—Å–∏—Å—Ç–µ–º–Ω–æ–µ)."""
    user: str
    message: str
    timestamp: datetime
    entry_type: str    # –ù–∞–ø—Ä–∏–º–µ—Ä: "user", "bot", "system"
–ú–æ–¥–µ–ª–∏ –ø–æ–º–æ–≥–∞—é—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏ –æ–±–ª–µ–≥—á–∏—Ç—å —Ä–∞–±–æ—Ç—É —Å –Ω–∏–º–∏ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –≤ Excel.
3. domain/knowledge.py
–õ–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞ –æ—Ç–≤–µ—Ç–∞ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π. –ù–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–∏—Å–∫ –ø–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é —Å—Ç—Ä–æ–∫–∏ (–∫–æ—Ä–æ—Ç–∫–∞—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è).
python
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
# domain/knowledge.py
import pandas as pd
from config.config import KNOWLEDGE_FILE, logger

class KnowledgeBase:
    def __init__(self):
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–∑—É –∑–Ω–∞–Ω–∏–π –∏–∑ Excel –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        try:
            self.df = pd.read_excel(KNOWLEDGE_FILE)
            logger.info("–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –∑–∞–≥—Ä—É–∂–µ–Ω–∞, %d –∑–∞–ø–∏—Å–µ–π", len(self.df))
        except FileNotFoundError:
            logger.error("–§–∞–π–ª –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π %s –Ω–µ –Ω–∞–π–¥–µ–Ω.", KNOWLEDGE_FILE)
            self.df = pd.DataFrame(columns=["Question", "Answer"])
    
    def find_answer(self, question_text: str) -> str:
        """
        –ù–∞—Ö–æ–¥–∏—Ç –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –≤–æ–ø—Ä–æ—Å–∞.
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –∏–ª–∏ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É, –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.
        """
        question_text = question_text.lower()
        for _, row in self.df.iterrows():
            q = str(row["Question"]).lower()
            if q in question_text or question_text in q:
                logger.info("–ù–∞–π–¥–µ–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞: %s", row["Question"])
                return str(row["Answer"])
        logger.info("–°–æ–≤–ø–∞–¥–µ–Ω–∏–π –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –¥–ª—è: %s", question_text)
        return ""  # –ù–µ—Ç –æ—Ç–≤–µ—Ç–∞ –≤ –±–∞–∑–µ
–ú–µ—Ç–æ–¥ find_answer –∏—â–µ—Ç –≤ –±–∞–∑–µ –ø–µ—Ä–≤–æ–µ —á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ. –í —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å NLP –∏–ª–∏ –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã–π –ø–æ–∏—Å–∫.
4. domain/logic.py
–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏: —Ä–∞–∑–±–æ—Ä —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ /start, /help, –ø–æ–∏—Å–∫ –æ—Ç–≤–µ—Ç–∞, —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∞–∫—Ü–∏–π.
python
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
# domain/logic.py
from datetime import datetime
from domain.models import ChatEntry, FeedbackEntry, FullLogEntry
from config.config import logger

class BotLogic:
    def __init__(self, knowledge_base, excel_repo):
        self.kb = knowledge_base        # –≠–∫–∑–µ–º–ø–ª—è—Ä KnowledgeBase
        self.repo = excel_repo          # –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤ Excel
    
    def process_message(self, user, text):
        """
        –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–∏–∑–≤–µ—Å—Ç–Ω–æ, —á—Ç–æ –±–æ—Ç —É–ø–æ–º—è–Ω—É—Ç).
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å –∫–ª—é—á–∞–º–∏:
        'answer' (—Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –∏–ª–∏ None),
        'reply' (—Ñ–ª–∞–≥, –Ω—É–∂–Ω–æ –ª–∏ –æ—Ç–≤–µ—á–∞—Ç—å),
        'mention_sasha' (True, –µ—Å–ª–∏ –Ω–∞–∂–∞—Ç–∞ –¥–∏–∑–ª–∞–π–∫)
        """
        logger.info("–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç %s: %s", user, text)
        # –û—á–∏—Å—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ –æ—Ç —É–ø–æ–º–∏–Ω–∞–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "@rmoc –ü—Ä–∏–≤–µ—Ç")
        clean_text = text.replace(f"@{os.getenv('BOT_NAME')}", "").strip().lower()

        # –ö–æ–º–∞–Ω–¥—ã /start –∏ /help
        if clean_text == "/start":
            reply = ("–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π. "
                     "–ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç, —É–ø–æ–º—è–Ω–∏—Ç–µ –º–µ–Ω—è —Ç–µ–≥–æ–º @rmoc –∏ –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å.")
            # –õ–æ–≥–∏—Ä—É–µ–º –∫–∞–∫ —Å–ª—É–∂–µ–±–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            self.repo.append_full_log(FullLogEntry(user, "/start", datetime.now(), "system"))
            return {"answer": reply, "reply": True, "mention_sasha": False}
        if clean_text == "/help":
            reply = ("–Ø —É–º–µ—é –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π. "
                     "–ü—Ä–æ—Å—Ç–æ —É–ø–æ–º—è–Ω–∏—Ç–µ –º–µ–Ω—è @rmoc –ø–µ—Ä–µ–¥ —Ç–µ–∫—Å—Ç–æ–º –≤–æ–ø—Ä–æ—Å–∞. "
                     "–ü–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ –≤—ã –º–æ–∂–µ—Ç–µ –Ω–∞–∂–∞—Ç—å ¬´üëç –õ–∞–π–∫¬ª –∏–ª–∏ ¬´üëé –î–∏–∑–ª–∞–π–∫¬ª.")
            self.repo.append_full_log(FullLogEntry(user, "/help", datetime.now(), "system"))
            return {"answer": reply, "reply": True, "mention_sasha": False}

        # –û–±—ã—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å
        answer = self.kb.find_answer(clean_text)
        if answer:
            # –ù–∞—à–ª–∏ –æ—Ç–≤–µ—Ç ‚Äî –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞
            entry = ChatEntry(user, clean_text, answer, datetime.now())
            self.repo.append_chat_history(entry)
            self.repo.append_full_log(FullLogEntry(user, text, datetime.now(), "user"))
            self.repo.append_full_log(FullLogEntry("bot", answer, datetime.now(), "bot"))
            return {"answer": answer, "reply": True, "mention_sasha": False}
        else:
            # –ù–µ—Ç –æ—Ç–≤–µ—Ç–∞ –≤ –±–∞–∑–µ
            reply = "–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ –∑–Ω–∞—é –æ—Ç–≤–µ—Ç–∞ –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å."
            self.repo.append_full_log(FullLogEntry(user, text, datetime.now(), "user"))
            self.repo.append_full_log(FullLogEntry("bot", reply, datetime.now(), "bot"))
            return {"answer": reply, "reply": True, "mention_sasha": False}

    def process_feedback(self, user, original_question, original_answer, feedback_type):
        """
        –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–æ–∫: feedback_type="like" –∏–ª–∏ "dislike".
        –ü—Ä–∏ –¥–∏–∑–ª–∞–π–∫–µ —É–ø–æ–º–∏–Ω–∞–µ–º @sasha.
        """
        entry = FeedbackEntry(user, original_question, original_answer, feedback_type, datetime.now())
        self.repo.append_feedback(entry)
        self.repo.append_full_log(FullLogEntry(user, f"feedback: {feedback_type}", datetime.now(), "user"))
        logger.info("–ü–æ–ª—É—á–µ–Ω –æ—Ç–∑—ã–≤ '%s' –æ—Ç %s –ø–æ –≤–æ–ø—Ä–æ—Å—É '%s'", feedback_type, user, original_question)
        
        mention_sasha = (feedback_type == "dislike")
        return mention_sasha
–ú–æ–¥—É–ª—å BotLogic –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –æ—Ç–∑—ã–≤–æ–≤. –û–Ω –≤—ã–∑—ã–≤–∞–µ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π excel_repo –¥–ª—è –∑–∞–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö.
5. infrastructure/excel_repo.py
–ß—Ç–µ–Ω–∏–µ –∏ –∑–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö –≤ Excel-—Ñ–∞–π–ª—ã. –ó–¥–µ—Å—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è pandas –∏ openpyxl.
python
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
# infrastructure/excel_repo.py
import os
import pandas as pd
from config.config import KNOWLEDGE_FILE, CHAT_HISTORY_FILE, FEEDBACK_FILE, FULL_LOG_FILE, logger

class ExcelRepository:
    def __init__(self):
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Excel-—Ñ–∞–π–ª—ã, —Å–æ–∑–¥–∞–≤–∞—è –∏—Ö —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
        self._init_file(KNOWLEDGE_FILE, ["Question", "Answer"], sample=True)
        self._init_file(CHAT_HISTORY_FILE, ["User", "Question", "Answer", "Timestamp"])
        self._init_file(FEEDBACK_FILE, ["User", "Question", "Answer", "Feedback", "Timestamp"])
        self._init_file(FULL_LOG_FILE, ["User", "Message", "Timestamp", "Type"])
    
    def _init_file(self, file_path, columns, sample=False):
        if not os.path.exists(file_path):
            logger.info("–°–æ–∑–¥–∞—ë–º —Ñ–∞–π–ª %s", file_path)
            df = pd.DataFrame(columns=columns)
            if sample and file_path == KNOWLEDGE_FILE:
                # –î–ª—è –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π –¥–æ–±–∞–≤–ª—è–µ–º –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                df = pd.DataFrame([
                    {"Question": "–ø—Ä–∏–≤–µ—Ç", "Answer": "–ü—Ä–∏–≤–µ—Ç! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?"},
                    {"Question": "–∫–∞–∫ –¥–µ–ª–∞", "Answer": "–°–ø–∞—Å–∏–±–æ, —Ö–æ—Ä–æ—à–æ! –ê —É –≤–∞—Å –∫–∞–∫?"}
                ])
            df.to_excel(file_path, index=False)
            logger.info("–§–∞–π–ª %s —Å–æ–∑–¥–∞–Ω", file_path)

    def append_chat_history(self, entry):
        df = pd.DataFrame([{
            "User": entry.user,
            "Question": entry.question,
            "Answer": entry.answer,
            "Timestamp": entry.timestamp
        }])
        df.to_excel(CHAT_HISTORY_FILE, mode='a', header=False, index=False)
        logger.info("–ó–∞–ø–∏—Å—å –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞: %s -> %s", entry.question, entry.answer)

    def append_feedback(self, entry):
        df = pd.DataFrame([{
            "User": entry.user,
            "Question": entry.question,
            "Answer": entry.answer,
            "Feedback": entry.feedback,
            "Timestamp": entry.timestamp
        }])
        df.to_excel(FEEDBACK_FILE, mode='a', header=False, index=False)
        logger.info("–û—Ç–∑—ã–≤ –¥–æ–±–∞–≤–ª–µ–Ω: %s => %s", entry.question, entry.feedback)

    def append_full_log(self, entry):
        df = pd.DataFrame([{
            "User": entry.user,
            "Message": entry.message,
            "Timestamp": entry.timestamp,
            "Type": entry.entry_type
        }])
        df.to_excel(FULL_LOG_FILE, mode='a', header=False, index=False)
        logger.info("–õ–æ–≥ –∑–∞–ø–∏—Å–∞–Ω: [%s] %s: %s", entry.entry_type, entry.user, entry.message)
–≠—Ç–æ—Ç –º–æ–¥—É–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Ä–∞–±–æ—Ç—É —Å Excel. –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ —Å–æ–∑–¥–∞—é—Ç—Å—è —Ñ–∞–π–ª—ã (—Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –≤ knowledge_base.xlsx). –ú–µ—Ç–æ–¥—ã append_... –¥–æ–±–∞–≤–ª—è—é—Ç –∑–∞–ø–∏—Å–∏ (–±–µ–∑ —á—Ç–µ–Ω–∏—è –≤—Å–µ–π —Ç–∞–±–ª–∏—Ü—ã) —Å –ø–æ–º–æ—â—å—é pandas.to_excel —Å —Ä–µ–∂–∏–º–æ–º mode='a'.
–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ pandas –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –≤ mode='a' –∏ header=False —Ç—Ä–µ–±—É–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å openpyxl –≤ –∫–∞—á–µ—Å—Ç–≤–µ –¥–≤–∏–∂–∫–∞. –§–∞–π–ª—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –∏ –¥–æ–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.
6. infrastructure/sber_sdk.py
–û–±–æ–ª–æ—á–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç–æ–º —á–µ—Ä–µ–∑ Dialog Bot SDK.
python
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
# infrastructure/sber_sdk.py
import grpc
from dialog_bot_sdk.bot import DialogBot
from config.config import BOT_ENDPOINT, BOT_TOKEN, logger

class SberBot:
    def __init__(self):
        # –°–æ–∑–¥–∞–Ω–∏–µ –±–æ—Ç–∞ —Å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º (SSL)
        self.bot = DialogBot.get_secure_bot(
            BOT_ENDPOINT,
            grpc.ssl_channel_credentials(),
            BOT_TOKEN
        )
        logger.info("–ë–æ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (endpoint: %s)", BOT_ENDPOINT)
    
    def on_message(self, func):
        """–ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –Ω–∞ —Å–æ–±—ã—Ç–∏–µ –≤—Ö–æ–¥—è—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è."""
        self.bot.messaging.on_message(func)
    
    def send_message(self, peer, text, attachments=None):
        """
        –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. 
        –ü–∞—Ä–∞–º–µ—Ç—Ä attachments ‚Äî —ç—Ç–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–Ω–æ–ø–∫–∏ (—Å–º. interface/keyboard.py).
        """
        # –í SDK Dialog –æ–¥–∏–Ω –∏–∑ —Å–ø–æ—Å–æ–±–æ–≤ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å –∫–Ω–æ–ø–∫–∞–º–∏ ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å attachments.
        if attachments:
            self.bot.messaging.send_message(peer, text, attachments=attachments)
        else:
            self.bot.messaging.send_message(peer, text)
–≠—Ç–æ—Ç –º–æ–¥—É–ª—å —É–ø—Ä–æ—â–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ SDK: —Å–æ–∑–¥–∞—ë—Ç –±–æ—Ç–∞ –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –º–µ—Ç–æ–¥—ã –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π.
7. interface/keyboard.py
–°–æ–∑–¥–∞–Ω–∏–µ "–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã" —Å –∫–Ω–æ–ø–∫–∞–º–∏ ¬´üëç –õ–∞–π–∫¬ª –∏ ¬´üëé –î–∏–∑–ª–∞–π–∫¬ª. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç SDK; –∑–¥–µ—Å—å –ø–æ–∫–∞–∑–∞–Ω –ø—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–ª—è attachments.
python
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
# interface/keyboard.py
def create_feedback_keyboard():
    """
    –°–æ–∑–¥–∞—ë—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–Ω–æ–ø–æ–∫ ¬´–õ–∞–π–∫¬ª –∏ ¬´–î–∏–∑–ª–∞–π–∫¬ª –¥–ª—è –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏—è –∫ —Å–æ–æ–±—â–µ–Ω–∏—é.
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤ –≤–∏–¥–µ —Å–ø–∏—Å–∫–∞ —Å–ª–æ–≤–∞—Ä–µ–π, —Å–æ–≤–º–µ—Å—Ç–∏–º—ã—Ö —Å Dialog Bot SDK.
    """
    # –ü—Ä–∏–º–µ—Ä–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–Ω–æ–ø–∫–∏ (—Ä–µ–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ SDK/–ø–ª–∞—Ç—Ñ–æ—Ä–º—ã)
    like_button = {
        "action": {"type": "text", "payload": "like"},
        "text": "üëç –õ–∞–π–∫"
    }
    dislike_button = {
        "action": {"type": "text", "payload": "dislike"},
        "text": "üëé –î–∏–∑–ª–∞–π–∫"
    }
    # –û–±—ë—Ä—Ç–∫–∞ –¥–ª—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (–º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–∑–ª–∏—á–Ω—ã–º –≤ SDK)
    keyboard = {
        "buttons": [like_button, dislike_button]
    }
    return [keyboard]
–ó–¥–µ—Å—å –º—ã —Ñ–æ—Ä–º–∏—Ä—É–µ–º —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π –ø—Ä–∏–º–µ—Ä –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã. –†–µ–∞–ª—å–Ω–æ SDK –º–æ–∂–µ—Ç –æ–∂–∏–¥–∞—Ç—å –¥—Ä—É–≥–æ–π —Ñ–æ—Ä–º–∞—Ç, –Ω–æ –∏–¥–µ—è –≤ —Ç–æ–º, —á—Ç–æ–±—ã –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –¥–≤–µ –∫–Ω–æ–ø–∫–∏ –∫ –æ—Ç–≤–µ—Ç—É.
–û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª main.py
–í main.py –º—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–æ—Ç–∞, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Ü–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π.
python
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
# main.py
import os
import sys
from config.config import BOT_NAME, SASHA_ID, logger
from infrastructure.sber_sdk import SberBot
from infrastructure.excel_repo import ExcelRepository
from domain.knowledge import KnowledgeBase
from domain.logic import BotLogic
from interface.keyboard import create_feedback_keyboard

def main():
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ –∏ –ª–æ–≥–∏–∫–∏
    excel_repo = ExcelRepository()
    knowledge_base = KnowledgeBase()
    bot_logic = BotLogic(knowledge_base, excel_repo)
    sber_bot = SberBot()

    @sber_bot.on_message
    def handle_message(params):
        try:
            peer = params.peer
            message = params.message

            # –¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            if not message.text_message:
                return
            text = message.text_message.text.strip()
            user = params.sender.uid  # –∏–ª–∏ params.sender.data.name ‚Äî –∑–∞–≤–∏—Å–∏—Ç –æ—Ç SDK

            # –ó–∞–ø–∏—Å—å –≤ –æ–±—â–∏–π –ª–æ–≥
            excel_repo.append_full_log(
                # –ó–∞–ø–∏—Å—å –≤—Ö–æ–¥—è—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                excel_repo, FullLogEntry(user, text, datetime.now(), "user")
            )

            # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –µ—Å–ª–∏ –Ω–µ—Ç —É–ø–æ–º–∏–Ω–∞–Ω–∏—è @rmoc
            if f"@{BOT_NAME}" not in text.lower():
                return  # –Ω–µ —É–ø–æ–º—è–Ω—É–ª–∏ –±–æ—Ç–∞

            # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è (–±–æ—Ç —É–ø–æ–º—è–Ω—É—Ç)
            result = bot_logic.process_message(user, text)
            if result["reply"]:
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –∏ –ø—Ä–∏–∫—Ä–µ–ø–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
                sber_bot.send_message(peer, result["answer"], attachments=create_feedback_keyboard())
        except Exception as e:
            logger.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è: %s", e, exc_info=True)

    @sber_bot.on_message
    def handle_feedback(params):
        """
        –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –∫–Ω–æ–ø–∫–∏ ¬´–õ–∞–π–∫/–î–∏–∑–ª–∞–π–∫¬ª –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç 
        —Ç–µ–∫—Å—Ç–æ–≤—ã–µ payload —Ç–∏–ø–∞ 'like' –∏–ª–∏ 'dislike'.
        """
        message = params.message
        if not message.text_message:
            return
        text = message.text_message.text.strip().lower()
        user = params.sender.uid
        peer = params.peer

        # –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç —Ä–∞–≤–µ–Ω 'like' –∏–ª–∏ 'dislike'
        if text in ("like", "dislike"):
            # TODO: –∑–¥–µ—Å—å –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–π –≤–æ–ø—Ä–æ—Å/–æ—Ç–≤–µ—Ç, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –±—ã–ª–æ –∫—Ä–µ–ø–ª–µ–Ω–∏–µ.
            # –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–º, —á—Ç–æ –≤–æ–ø—Ä–æ—Å —Ö—Ä–∞–Ω–∏—Ç—Å—è –≥–¥–µ-—Ç–æ, –ª–∏–±–æ
            # —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –º–µ—Ç–∫–∏ –ø–æ–º–æ–≥–∞—é—â–∏–µ.
            original_question = "–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω"   # –º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ state –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            original_answer = "–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω"
            mention_sasha = bot_logic.process_feedback(user, original_question, original_answer, text)
            if mention_sasha and SASHA_ID:
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ @sasha
                notification = f"@{os.getenv('SASHA_ID')} –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user} –Ω–µ–¥–æ–≤–æ–ª–µ–Ω –æ—Ç–≤–µ—Ç–æ–º."
                sber_bot.send_message(peer, notification)
            else:
                sber_bot.send_message(peer, "–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–∑—ã–≤!")
    
    logger.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –æ–∂–∏–¥–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π...")
    # –¢–∞–∫ –∫–∞–∫ SDK —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏, –æ–±—ã—á–Ω—ã–π —Ü–∏–∫–ª —Å–æ–±—ã—Ç–∏–π –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ SDK.
    try:
        sber_bot.bot.run()  # –ú–µ—Ç–æ–¥ –∑–∞–ø—É—Å–∫–∞ (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è SDK, –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ bot = DialogBot...)
    except Exception as e:
        logger.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞: %s", e)

if __name__ == "__main__":
    main()
–í main.py –º—ã —Å–æ–∑–¥–∞—ë–º —ç–∫–∑–µ–º–ø–ª—è—Ä—ã –ª–æ–≥–∏–∫–∏ –∏ SDK, —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ on_message. –ü–µ—Ä–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –±–æ—Ç–∞ @rmoc: –∏—â–µ—Ç –æ—Ç–≤–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –µ–≥–æ —Å –∫–Ω–æ–ø–∫–∞–º–∏. –í—Ç–æ—Ä–æ–π ‚Äì –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –æ—Ç–≤–µ—Ç –æ—Ç –∫–Ω–æ–ø–æ–∫, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç like/dislike –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —É–≤–µ–¥–æ–º–ª—è–µ—Ç @sasha.
–í–∞–∂–Ω–æ: SDK –º–æ–∂–µ—Ç –∏–º–µ—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π —Å–ø–æ—Å–æ–± –æ—Ç–ª–∏—á–∏—Ç—å –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–æ–∫. –ó–¥–µ—Å—å –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –º—ã —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤ on_message —Å —Ç–µ–∫—Å—Ç–æ–º "like" –∏–ª–∏ "dislike". –í —Ä–µ–∞–ª—å–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å correct callback/CB, –ª–∏–±–æ —Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞.
–ò—Ç–æ–≥–∏
–ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –ø—Ä–æ–µ–∫—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç —á–∏—Å—Ç—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É (—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ —Å–ª–æ–∏ config, domain, infrastructure, interface) –∏ –≤—Å–µ —Ç—Ä–µ–±—É–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
–û–±—Ä–∞–±–æ—Ç–∫–∞ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è: –±–æ—Ç —Ä–µ–∞–≥–∏—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —Å @rmoc.
–ü–æ–∏—Å–∫ –æ—Ç–≤–µ—Ç–∞: –ø–æ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π (knowledge_base.xlsx) –º–µ—Ç–æ–¥–æ–º —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è.
–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏: –∫ –æ—Ç–≤–µ—Ç—É –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω—ã –∫–Ω–æ–ø–∫–∏ ¬´üëç –õ–∞–π–∫¬ª –∏ ¬´üëé –î–∏–∑–ª–∞–π–∫¬ª.
–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∏–∑–ª–∞–π–∫–∞: –ø—Ä–∏ –Ω–∞–∂–∞–Ω–∏–∏ ¬´–î–∏–∑–ª–∞–π–∫¬ª –±–æ—Ç —É–ø–æ–º–∏–Ω–∞–µ—Ç @sasha –≤ –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏.
–•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö: –≤—Å–µ –¥–∏–∞–ª–æ–≥–∏ –∏ –æ—Ç–∑—ã–≤—ã –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ Excel-—Ñ–∞–π–ª—ã (chat_history.xlsx, feedback_data.xlsx, full_chat_log.xlsx).
–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: —Å–æ–±—ã—Ç–∏—è –∏ –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ —Ñ–∞–π–ª bot.log –∏ –≤—ã–≤–æ–¥—è—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å.
–ö–æ–º–∞–Ω–¥—ã /start, /help: —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏ –ø–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –±–æ—Ç–∞.
–ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ .env. –í—Å–µ –º–æ–¥—É–ª–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç –ø–æ–¥—Ä–æ–±–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, —É–ø—Ä–æ—â–∞—é—â–∏–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫—É –∫–æ–¥–∞.



from dialog_bot_sdk.bot import DialogBot
from dialog_bot_sdk.entities.messaging import MessageHandler, MessageContentType, CommandHandler
import logging


class SberBot:
    def __init__(self, endpoint: str, token: str, cert_path: str):
        self.bot = DialogBot.get_secure_bot(
            endpoint,
            token,
            cert_path
        )
        logging.info(f"–ë–æ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (endpoint: {endpoint})")

    def on_message(self, func):
        self.bot.messaging.message_handler([
            MessageHandler(func, MessageContentType.TEXT_MESSAGE)
        ])

    def on_command(self, command: str, description: str):
        def decorator(func):
            self.bot.messaging.command_handler([
                CommandHandler(func, command, description=description)
            ])
            return func
        return decorator

    def start_polling(self):
        self.bot.updates.on_updates(
            do_read_message=True,
            do_register_commands=True
        )



sber_bot = SberBot(endpoint, token, cert_path)

@sber_bot.on_command("start", "–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞")
def start_handler(message: UpdateMessage):
    # ...

@sber_bot.on_message
def echo_handler(message: UpdateMessage):
    # ...

sber_bot.start_polling()

