1. main.py
python
ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ
Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ
import logging
from config.config import BOT_ENDPOINT, BOT_TOKEN, BOT_NAME, SASHA_ID, logger
from infrastructure.sber_sdk import SberBot
from infrastructure.excel_repo import ExcelRepository
from domain.knowledge import KnowledgeBase
from domain.logic import BotLogic
from handlers.message_handler import register_handlers


def main():
    logger.info("Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ±Ğ¾Ñ‚Ğ°...")

    # Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸ĞµĞ² Ğ¸ Ğ±Ğ¸Ğ·Ğ½ĞµÑ-Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¸
    excel_repo = ExcelRepository()
    knowledge_base = KnowledgeBase()
    bot_logic = BotLogic(knowledge_base, excel_repo)

    # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ ÑĞºĞ·ĞµĞ¼Ğ¿Ğ»ÑÑ€Ğ° Ğ±Ğ¾Ñ‚Ğ°
    sber_bot = SberBot(BOT_ENDPOINT, BOT_TOKEN)

    # Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹
    register_handlers(sber_bot, bot_logic, excel_repo)

    logger.info(f"Ğ‘Ğ¾Ñ‚ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ (endpoint: {BOT_ENDPOINT}, bot_name: @{BOT_NAME})")

    try:
        sber_bot.start_polling()
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞºĞµ Ğ±Ğ¾Ñ‚Ğ°: {e}", exc_info=True)


if __name__ == "__main__":
    main()
2. infrastructure/sber_sdk.py
python
ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ
Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ
from dialog_bot_sdk.bot import DialogBot
from dialog_bot_sdk.entities.messaging import MessageHandler, CommandHandler, MessageContentType
from dialog_bot_sdk.utils import AsyncTask
import logging

logger = logging.getLogger(__name__)


class SberBot:
    def __init__(self, endpoint: str, token: str):
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ±Ğ¾Ñ‚Ğ° Ñ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ñ‹Ğ¼ ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸ĞµĞ¼
        self.bot = DialogBot.create_bot({
            "endpoint": endpoint,
            "token": token,
            # ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ "root_certificates" ĞµÑĞ»Ğ¸ Ğ½Ğ°Ğ´Ğ¾
        })
        self.messaging = self.bot.messaging

    def on_message(self, func):
        self.messaging.message_handler([
            MessageHandler(func, MessageContentType.TEXT_MESSAGE)
        ])

    def on_command(self, command: str, description: str):
        def decorator(func):
            self.messaging.command_handler([
                CommandHandler(func, command, description=description)
            ])
            return func
        return decorator

    def send_message(self, peer, text: str, attachments=None):
        self.messaging.send_message(peer, text, attachments=attachments)

    def start_polling(self):
        self.bot.updates.on_updates(
            do_read_message=True,
            do_register_commands=True
        )
        self.bot.run()
3. infrastructure/excel_repo.py
python
ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ
Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ
import os
import logging
from datetime import datetime
from openpyxl import Workbook, load_workbook

logger = logging.getLogger(__name__)


class ExcelRepository:
    def __init__(self):
        # ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
        self.knowledge_file = "knowledge_base.xlsx"
        self.chat_history_file = "chat_history.xlsx"
        self.feedback_file = "feedback_data.xlsx"
        self.full_log_file = "full_chat_log.xlsx"

        self._init_files()

    def _init_files(self):
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ¸/Ğ¸Ğ»Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Excel-Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ñ Ğ½ÑƒĞ¶Ğ½Ñ‹Ğ¼Ğ¸ Ğ»Ğ¸ÑÑ‚Ğ°Ğ¼Ğ¸ Ğ¸ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ°Ğ¼Ğ¸
        self._create_if_not_exists(self.knowledge_file, ["Question", "Answer"])
        self._create_if_not_exists(self.chat_history_file, ["User", "Message", "Timestamp"])
        self._create_if_not_exists(self.feedback_file, ["User", "Question", "Answer", "Feedback", "Timestamp"])
        self._create_if_not_exists(self.full_log_file, ["User", "Message", "Timestamp", "Source"])

    def _create_if_not_exists(self, filename: str, headers: list):
        if not os.path.exists(filename):
            logger.info(f"Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ñ„Ğ°Ğ¹Ğ» {filename}")
            wb = Workbook()
            ws = wb.active
            ws.append(headers)
            wb.save(filename)
            logger.info(f"Ğ¤Ğ°Ğ¹Ğ» {filename} ÑĞ¾Ğ·Ğ´Ğ°Ğ½")

    def load_knowledge(self):
        # Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ±Ğ°Ğ·Ñƒ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ² Ğ²Ğ¸Ğ´Ğµ ÑĞ¿Ğ¸ÑĞºĞ° ÑĞ»Ğ¾Ğ²Ğ°Ñ€ĞµĞ¹
        wb = load_workbook(self.knowledge_file)
        ws = wb.active
        knowledge = []
        for row in ws.iter_rows(min_row=2, values_only=True):
            if row[0] and row[1]:
                knowledge.append({"question": row[0], "answer": row[1]})
        logger.info(f"Ğ‘Ğ°Ğ·Ğ° Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ°, {len(knowledge)} Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹")
        return knowledge

    def append_chat_history(self, user: str, message: str, timestamp: datetime):
        wb = load_workbook(self.chat_history_file)
        ws = wb.active
        ws.append([user, message, timestamp.isoformat()])
        wb.save(self.chat_history_file)

    def append_feedback(self, user: str, question: str, answer: str, feedback: str, timestamp: datetime):
        wb = load_workbook(self.feedback_file)
        ws = wb.active
        ws.append([user, question, answer, feedback, timestamp.isoformat()])
        wb.save(self.feedback_file)

    def append_full_log(self, user: str, message: str, timestamp: datetime, source: str):
        wb = load_workbook(self.full_log_file)
        ws = wb.active
        ws.append([user, message, timestamp.isoformat(), source])
        wb.save(self.full_log_file)
4. domain/knowledge.py
python
ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ
Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ
import logging

logger = logging.getLogger(__name__)

class KnowledgeBase:
    def __init__(self):
        self.data = []

    def load(self, knowledge_data: list):
        self.data = knowledge_data
        logger.info(f"Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ¾ {len(self.data)} ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ğ±Ğ°Ğ·Ñ‹ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹")

    def find_answer(self, question: str) -> str | None:
        # ĞÑ‡ĞµĞ½ÑŒ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ¹ Ğ¿Ğ¾Ğ¸ÑĞº Ñ‚Ğ¾Ñ‡Ğ½Ğ¾Ğ³Ğ¾ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ñ (Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ·Ğ°Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ½Ğ° Ñ‡Ñ‚Ğ¾-Ñ‚Ğ¾ ÑĞ»Ğ¾Ğ¶Ğ½ĞµĞµ)
        question = question.lower()
        for entry in self.data:
            if entry["question"].lower() == question:
                return entry["answer"]
        return None
5. domain/logic.py
python
ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ
Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ
import logging
from datetime import datetime

logger = logging.getLogger(__name__)

class BotLogic:
    def __init__(self, knowledge_base: KnowledgeBase, excel_repo):
        self.kb = knowledge_base
        self.repo = excel_repo

    def process_message(self, user: str, text: str) -> dict:
        """
        ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ:
        - Ğ·Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ Ğ² Ğ»Ğ¾Ğ³
        - Ğ¸Ñ‰ĞµÑ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹
        - Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ñ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¾Ğ¼ Ğ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸ĞµĞ¼ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸
        """
        self.repo.append_chat_history(user, text, datetime.now())
        answer = self.kb.find_answer(text)
        if answer:
            logger.info(f"ĞĞ°Ğ¹Ğ´ĞµĞ½ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ {user}")
            return {"reply": True, "answer": answer}
        else:
            logger.info(f"ĞÑ‚Ğ²ĞµÑ‚ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ´Ğ»Ñ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ {user}")
            return {"reply": False, "answer": "Ğ˜Ğ·Ğ²Ğ¸Ğ½Ğ¸Ñ‚Ğµ, Ñ Ğ½Ğµ Ğ·Ğ½Ğ°Ñ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° Ğ½Ğ° ÑÑ‚Ğ¾Ñ‚ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ."}

    def process_feedback(self, user: str, question: str, answer: str, feedback: str) -> bool:
        """
        ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¾Ñ‚Ğ·Ñ‹Ğ² (like/dislike):
        - ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ Ğ² Ñ„Ğ°Ğ¹Ğ»
        - Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ True, ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ¸Ñ‚ÑŒ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ° (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, Ğ¿Ñ€Ğ¸ dislike)
        """
        self.repo.append_feedback(user, question, answer, feedback, datetime.now())
        notify_admin = feedback.lower() == "dislike"
        logger.info(f"ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ° Ğ¾Ñ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ {user}, notify_admin={notify_admin}")
        return notify_admin
6. handlers/message_handler.py
python
ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ
Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ
import logging
from datetime import datetime
from config.config import BOT_NAME, SASHA_ID
from interface.keyboard import create_feedback_keyboard

logger = logging.getLogger(__name__)


def register_handlers(bot, bot_logic, excel_repo):
    @bot.on_message
    def handle_message(params):
        try:
            peer = params.peer
            message = params.message

            if not message.text_message:
                return
            text = message.text_message.text.strip()
            user = params.sender.uid

            # Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
            excel_repo.append_full_log(user, text, datetime.now(), "user")

            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑƒĞ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ğµ Ğ±Ğ¾Ñ‚Ğ°
            if f"@{BOT_NAME}" not in text.lower():
                return

            # ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
            result = bot_logic.process_message(user, text)

            if result["reply"]:
                bot.send_message(peer, result["answer"], attachments=create_feedback_keyboard())
        except Exception as e:
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ: {e}", exc_info=True)


    @bot.on_message
    def handle_feedback(params):
        message = params.message
        if not message.text_message:
            return
        text = message.text_message.text.strip().lower()
        user = params.sender.uid
        peer = params.peer

        if text in ("like", "dislike"):
            # Ğ’ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğµ Ñ‚ÑƒÑ‚ Ğ½ÑƒĞ¶Ğ½Ğ¾ ÑĞ²ÑĞ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ¾Ñ‚Ğ·Ñ‹Ğ² Ñ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğ¼ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ¾Ğ¼/Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¾Ğ¼
            original_question = "ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚ĞµĞ½"
            original_answer = "ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚ĞµĞ½"

            mention_admin = bot_logic.process_feedback(user, original_question, original_answer, text)
            if mention_admin and SASHA_ID:
                notification = f"@{SASHA_ID} ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {user} Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ğ» Ğ¾Ñ‚Ñ€Ğ¸Ñ†Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ğ¾Ñ‚Ğ·Ñ‹Ğ²."
                bot.send_message(peer, notification)
            else:
                bot.send_message(peer, "Ğ¡Ğ¿Ğ°ÑĞ¸Ğ±Ğ¾ Ğ·Ğ° Ğ²Ğ°Ñˆ Ğ¾Ñ‚Ğ·Ñ‹Ğ²!")
7. interface/keyboard.py
python
ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ
Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ
from dialog_bot_sdk.entities.messaging import InteractiveMedia, Button, ButtonType

def create_feedback_keyboard() -> InteractiveMedia:
    buttons = [
        Button(text="ğŸ‘", type=ButtonType.TEXT, payload="like"),
        Button(text="ğŸ‘", type=ButtonType.TEXT, payload="dislike"),
    ]
    return InteractiveMedia(buttons=buttons)
