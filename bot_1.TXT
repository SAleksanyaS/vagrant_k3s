medium.com
medium.com
–í —ç—Ç–æ–º –ø—Ä–æ–µ–∫—Ç–µ –º—ã –ø—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–∏–Ω—Ü–∏–ø—ã —á–∏—Å—Ç–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã (¬´Clean Architecture¬ª) –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –ø–æ–≤—ã—à–µ–Ω–∏—è —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç–∏. –°–∏—Å—Ç–µ–º–∞ —Ä–∞–∑–¥–µ–ª–µ–Ω–∞ –Ω–∞ —Å–ª–æ–∏: –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, –¥–æ–º–µ–Ω–Ω—É—é –ª–æ–≥–∏–∫—É, –ø—Ä–∏–∫–ª–∞–¥–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏, –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (UI). –í–Ω–µ—à–Ω–∏–µ —Å–ª–æ–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, UI –∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞) –∑–∞–≤–∏—Å—è—Ç –æ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö (–¥–æ–º–µ–Ω–∞ –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
medium.com
medium.com
. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç, –Ω–∞–ø—Ä–∏–º–µ—Ä, –∑–∞–º–µ–Ω–∏—Ç—å –¥–µ—Ç–∞–ª–∏ —Ä–∞–±–æ—Ç—ã —Å Excel –∏–ª–∏ API –°–±–µ—Ä–ß–∞—Ç–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏.
–û—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
–û—Ç–≤–µ—Ç –Ω–∞ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è: –±–æ—Ç –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤—Ö–æ–¥—è—â–µ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏, –µ—Å–ª–∏ –≤ –Ω—ë–º –µ—Å—Ç—å —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –±–æ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´–±–æ—Ç¬ª –∏–ª–∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø–æ –∏–º–µ–Ω–∏), —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç.
–ü–æ–∏—Å–∫ –æ—Ç–≤–µ—Ç–∞ –ø–æ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π: –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ–∞–π–ª knowledge_base.xlsx, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –≤–æ–ø—Ä–æ—Å‚Äì–æ—Ç–≤–µ—Ç. –ë–æ—Ç –∏—â–µ—Ç –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –æ—Ç–≤–µ—Ç –ø–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é –∏–ª–∏ –ø–æ—Ö–æ–∂–µ—Å—Ç–∏ —Å—Ç—Ä–æ–∫ (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å difflib.get_close_matches
docs.python.org
 –∏–ª–∏ SequenceMatcher).
–ö–Ω–æ–ø–∫–∏ ¬´–ª–∞–π–∫¬ª/¬´–¥–∏–∑–ª–∞–π–∫¬ª: –≤–º–µ—Å—Ç–µ —Å –æ—Ç–≤–µ—Ç–æ–º –±–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–∞–∑–º–µ—Ç–∫—É –∫–Ω–æ–ø–æ–∫. Sber Chat API –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å JSON-–æ–±—ä–µ–∫—Ç —Ç–∏–ø–∞ "buttons" —Å –º–∞—Å—Å–∏–≤–æ–º –∫–Ω–æ–ø–æ–∫
developers.sber.ru
 (–Ω–∞—à –∫–æ–¥ –æ—Ñ–æ—Ä–º–ª—è–µ—Ç —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –≤ –∫–ª–∞—Å—Å–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∫–Ω–æ–ø–æ–∫).
–¢–µ–≥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –Ω–∞ –¥–∏–∑–ª–∞–π–∫–µ: –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª ¬´–¥–∏–∑–ª–∞–π–∫¬ª, –±–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, @sasha), —á—Ç–æ–±—ã –æ–Ω –º–æ–≥ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∑–∞–¥–∞—ë—Ç—Å—è –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é —Å—Ä–µ–¥—ã.
–°–∞–º–æ–æ–±—É—á–µ–Ω–∏–µ (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ): –≤—Å–µ –¥–∏–∞–ª–æ–≥–∏ –∏ –æ—Ü–µ–Ω–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ Excel-—Ñ–∞–π–ª—ã –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –¥–æ—Ä–∞–±–æ—Ç–∫–∏. –í–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ chat_history.xlsx, –æ—Ü–µ–Ω–∫–∏ ‚Äì –≤ feedback_data.xlsx, –∞ –ø–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π ‚Äì –≤ full_chat_log.xlsx. –î–ª—è —Ä–∞–±–æ—Ç—ã —Å Excel –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ pandas
digitalocean.com
digitalocean.com
.
–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
medium.com
–§–∞–π–ª—ã –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω—ã –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø–∞–º —á–∏—Å—Ç–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:
config/ ‚Äì –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (—á—Ç–µ–Ω–∏–µ .env —á–µ—Ä–µ–∑ python-dotenv).
domain/ ‚Äì –¥–æ–º–µ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏ –∏ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å—É—â–Ω–æ—Å—Ç–∏ –≤–æ–ø—Ä–æ—Å-–æ—Ç–≤–µ—Ç, —Å–æ–æ–±—â–µ–Ω–∏–µ).
application/ ‚Äì —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ (use cases) –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏.
infrastructure/ ‚Äì —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è: —Ä–∞–±–æ—Ç–∞ —Å Excel –∏ API –°–±–µ—Ä–ß–∞—Ç–∞.
interface/ ‚Äì –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã (—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–ª—è –∫–Ω–æ–ø–æ–∫, –∫–∞—Ä—Ç–æ—á–µ–∫).
main.py ‚Äì —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤, –ø—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞.
–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π:
config/__init__.py, config/settings.py ‚Äì —á—Ç–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –∏ endpoint –∏–∑ .env
geeksforgeeks.org
.
domain/__init__.py, domain/models.py ‚Äì –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ (–∫–ª–∞—Å—Å –≤–æ–ø—Ä–æ—Å-–æ—Ç–≤–µ—Ç, —Å–æ–æ–±—â–µ–Ω–∏–µ, –æ—Ü–µ–Ω–∫–∞).
application/__init__.py, application/use_cases.py ‚Äì —Å—Ü–µ–Ω–∞—Ä–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è (HandleMessageUseCase) –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ü–µ–Ω–∫–∏ (HandleFeedbackUseCase), –ª–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ –æ—Ç–≤–µ—Ç–∞.
infrastructure/__init__.py, infrastructure/excel_storage.py ‚Äì –∫–ª–∞—Å—Å—ã –¥–ª—è —á—Ç–µ–Ω–∏—è/–∑–∞–ø–∏—Å–∏ Excel (KnowledgeBaseRepository, ChatHistoryRepository –∏ —Ç.–¥.) —Å –ø–æ–º–æ—â—å—é pandas
digitalocean.com
; infrastructure/sber_chat_client.py ‚Äì –∫–ª–∏–µ–Ω—Ç –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å REST API –°–±–µ—Ä–ß–∞—Ç–∞
developers.sber.ru
.
interface/__init__.py, interface/buttons.py ‚Äì –æ–ø–∏—Å–∞–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ (—Ç–∏–ø buttons, —Å–ø–∏—Å–æ–∫ –∫–Ω–æ–ø–æ–∫) —Å–æ–≥–ª–∞—Å–Ω–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ Sber Chat API
developers.sber.ru
.
–û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª main.py ‚Äì –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è, –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ (–±–µ–∑ Docker, –≤ virtualenv).
–í—Å–µ –∏–º–ø–æ—Ä—Ç—ã —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω—ã, __init__.py –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –∫–∞–∂–¥—ã–π –º–æ–¥—É–ª—å. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –∏–∑ .env (—Ç–æ–∫–µ–Ω –°–±–µ—Ä–ß–∞—Ç –∏ URL API)
geeksforgeeks.org
. –ö–æ–¥ –Ω–∞–ø–∏—Å–∞–Ω –Ω–∞ Python 3 –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –±–µ–∑ –æ—à–∏–±–æ–∫. –ù–∏–∂–µ –ø—Ä–∏–≤–µ–¥–µ–Ω–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤.
config/settings.py
geeksforgeeks.org
–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ —Ñ–∞–π–ª–∞ .env —Å –ø–æ–º–æ—â—å—é python-dotenv. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ SBER_CHAT_TOKEN, SBER_CHAT_URL –∏ ADMIN_USER (–∏–º—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞) –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –º–æ–¥—É–ª–µ.
python
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
# config/settings.py
import os
from dotenv import load_dotenv

load_dotenv()  # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env

# –¢–æ–∫–µ–Ω –∫–∞–Ω–∞–ª–∞ Chat API –∏ URL (endpoint)
SBER_CHAT_TOKEN = os.getenv("SBER_CHAT_TOKEN")
SBER_CHAT_URL = os.getenv("SBER_CHAT_URL")

# –ò–º—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø—Ä–∏ "–¥–∏–∑–ª–∞–π–∫"
ADMIN_USER = os.getenv("ADMIN_USER", "sasha")
domain/models.py
medium.com
–î–æ–º–µ–Ω–Ω—ã–π —Å–ª–æ–π —Å–æ–¥–µ—Ä–∂–∏—Ç –±–∞–∑–æ–≤—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏. –ó–¥–µ—Å—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –º–æ–¥–µ–ª–∏ –≤–æ–ø—Ä–æ—Å-–æ—Ç–≤–µ—Ç (QAPair), —Å–æ–æ–±—â–µ–Ω–∏—è (Message) –∏ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ (Feedback).
python
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
# domain/models.py
from dataclasses import dataclass
from datetime import datetime

@dataclass
class QAPair:
    question: str
    answer: str

@dataclass
class Message:
    user_id: str
    text: str
    timestamp: datetime

@dataclass
class Feedback:
    user_id: str
    feedback: str  # 'like' –∏–ª–∏ 'dislike'
    timestamp: datetime
application/use_cases.py
docs.python.org
–í —Å–ª–æ–µ use cases —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞: –ø–æ–∏—Å–∫ –æ—Ç–≤–µ—Ç–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏. –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º difflib –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –ø–æ—Ö–æ–∂–µ—Å—Ç–∏ –≤–æ–ø—Ä–æ—Å–æ–≤
docs.python.org
.
python
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
# application/use_cases.py
from difflib import SequenceMatcher
from datetime import datetime
from domain.models import QAPair, Message, Feedback

class HandleMessageUseCase:
    def __init__(self, knowledge_repo, chat_history_repo, full_log_repo):
        self.knowledge_repo = knowledge_repo
        self.chat_history_repo = chat_history_repo
        self.full_log_repo = full_log_repo

    def execute(self, user_id: str, text: str):
        # –õ–æ–≥–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ø–æ–ª–Ω—ã–π –∂—É—Ä–Ω–∞–ª
        msg = Message(user_id=user_id, text=text, timestamp=datetime.utcnow())
        self.full_log_repo.append_entry(msg, is_bot=False)

        # –ü–æ–∏—Å–∫ –æ—Ç–≤–µ—Ç–∞ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π (—á–∞—Å—Ç–∏—á–Ω–æ–µ –∏ –ø—Ä–∏–±–ª–∏–∂—ë–Ω–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ)
        answer = self._find_best_answer(text)
        if not answer:
            answer = "–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ –∑–Ω–∞—é –æ—Ç–≤–µ—Ç–∞ –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å."

        # –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –±–æ—Ç–∞
        msg_bot = Message(user_id="bot", text=answer, timestamp=datetime.utcnow())
        self.full_log_repo.append_entry(msg_bot, is_bot=True)

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é (–≤–æ–ø—Ä–æ—Å-–æ—Ç–≤–µ—Ç-—é–∑–µ—Ä)
        self.chat_history_repo.append_entry(question=text, answer=answer, user_id=user_id)
        return answer

    def _find_best_answer(self, query: str) -> str:
        qa_list = self.knowledge_repo.get_all()
        # –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –ø—Ä–æ—Å—Ç–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ (—á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–æ –ø–æ–¥—Å—Ç—Ä–æ–∫–µ)
        for qa in qa_list:
            if query.lower() in qa.question.lower():
                return qa.answer
        # –ò–Ω–∞—á–µ –≤—ã–±–∏—Ä–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ—Ö–æ–∂–∏–π –ø–æ SequenceMatcher
        best_ratio = 0
        best_answer = None
        for qa in qa_list:
            ratio = SequenceMatcher(None, query.lower(), qa.question.lower()).ratio()
            if ratio > best_ratio:
                best_ratio = ratio
                best_answer = qa.answer
        # –ü–æ—Ä–æ–≥–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, >0.5)
        if best_ratio > 0.5:
            return best_answer
        return None

class HandleFeedbackUseCase:
    def __init__(self, feedback_repo, full_log_repo, chat_client, admin_user):
        self.feedback_repo = feedback_repo
        self.full_log_repo = full_log_repo
        self.chat_client = chat_client
        self.admin_user = admin_user

    def execute(self, user_id: str, feedback: str):
        # –õ–æ–≥–∏—Ä—É–µ–º –æ—Ü–µ–Ω–∫—É
        fb = Feedback(user_id=user_id, feedback=feedback, timestamp=datetime.utcnow())
        self.feedback_repo.append_entry(fb)

        # –ü—Ä–∏ –¥–∏–∑–ª–∞–π–∫–µ —É–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        if feedback == "dislike":
            alert_text = f"@{self.admin_user} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –Ω–µ –¥–æ–≤–æ–ª–µ–Ω –æ—Ç–≤–µ—Ç–æ–º."
            # –õ–æ–≥–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
            msg_admin = Message(user_id=user_id, text=alert_text, timestamp=datetime.utcnow())
            self.full_log_repo.append_entry(msg_admin, is_bot=True)
            self.chat_client.send_message(user_id, alert_text)
infrastructure/excel_storage.py
digitalocean.com
–ó–¥–µ—Å—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Excel-—Ñ–∞–π–ª–∞–º–∏ —Å –ø–æ–º–æ—â—å—é pandas
digitalocean.com
digitalocean.com
. –ö–∞–∂–¥—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —É–º–µ–µ—Ç —á–∏—Ç–∞—Ç—å/–¥–æ–ø–∏—Å—ã–≤–∞—Ç—å –∑–∞–ø–∏—Å–∏.
python
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
# infrastructure/excel_storage.py
import pandas as pd
from pathlib import Path
from domain.models import QAPair, Message, Feedback

class KnowledgeBaseRepository:
    def __init__(self, file_path):
        self.file_path = Path(file_path)
        # –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞—ë–º –ø—É—Å—Ç–æ–π
        if not self.file_path.exists():
            df = pd.DataFrame(columns=["question", "answer"])
            df.to_excel(self.file_path, index=False)

    def get_all(self):
        df = pd.read_excel(self.file_path)
        return [QAPair(row["question"], row["answer"]) for _, row in df.iterrows()]

class ChatHistoryRepository:
    def __init__(self, file_path):
        self.file_path = Path(file_path)
        if not self.file_path.exists():
            df = pd.DataFrame(columns=["question", "answer", "user_id"])
            df.to_excel(self.file_path, index=False)

    def append_entry(self, question, answer, user_id):
        df_new = pd.DataFrame([{"question": question, "answer": answer, "user_id": user_id}])
        df = pd.read_excel(self.file_path)
        df = pd.concat([df, df_new], ignore_index=True)
        df.to_excel(self.file_path, index=False)

class FeedbackRepository:
    def __init__(self, file_path):
        self.file_path = Path(file_path)
        if not self.file_path.exists():
            df = pd.DataFrame(columns=["user_id", "feedback", "timestamp"])
            df.to_excel(self.file_path, index=False)

    def append_entry(self, feedback: Feedback):
        df_new = pd.DataFrame([{
            "user_id": feedback.user_id,
            "feedback": feedback.feedback,
            "timestamp": feedback.timestamp
        }])
        df = pd.read_excel(self.file_path)
        df = pd.concat([df, df_new], ignore_index=True)
        df.to_excel(self.file_path, index=False)

class FullChatLogRepository:
    def __init__(self, file_path):
        self.file_path = Path(file_path)
        if not self.file_path.exists():
            df = pd.DataFrame(columns=["timestamp", "user_id", "message", "is_bot"])
            df.to_excel(self.file_path, index=False)

    def append_entry(self, message: Message, is_bot: bool):
        df_new = pd.DataFrame([{
            "timestamp": message.timestamp,
            "user_id": message.user_id,
            "message": message.text,
            "is_bot": is_bot
        }])
        df = pd.read_excel(self.file_path)
        df = pd.concat([df, df_new], ignore_index=True)
        df.to_excel(self.file_path, index=False)
infrastructure/sber_chat_client.py
developers.sber.ru
–ö–ª–∏–µ–Ω—Ç –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å REST API –°–±–µ—Ä–ß–∞—Ç–∞. –î–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ–º GET-–∑–∞–ø—Ä–æ—Å—ã –∫ —ç–Ω–¥–ø–æ–∏–Ω—Ç—É /chatapi/bot/{token}
developers.sber.ru
.
python
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
# infrastructure/sber_chat_client.py
import uuid
import requests

class SberChatClient:
    def __init__(self, token: str, endpoint: str):
        self.token = token
        self.endpoint = endpoint.rstrip('/')

    def send_message(self, chat_id: str, text: str):
        """
        –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é chat_id.
        –ù–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ –Ω—É–∂–Ω–æ –ø–æ–¥—Å—Ç–∞–≤–ª—è—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (clientId –∏ —Ç.–¥.).
        """
        url = f"{self.endpoint}/chatapi/bot/{self.token}"
        params = {
            "clientId": str(uuid.uuid4()),
            "query": text
        }
        try:
            response = requests.get(url, params=params)
            response.raise_for_status()
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
interface/buttons.py
developers.sber.ru
–ö–ª–∞—Å—Å –æ–ø–∏—Å—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫—É –∏ –±–ª–æ–∫ –∫–Ω–æ–ø–æ–∫ –≤ —Ñ–æ—Ä–º–∞—Ç–µ, –æ–∂–∏–¥–∞–µ–º–æ–º Chat API (¬´type":"buttons" –∏ —Å–ø–∏—Å–æ–∫ text-–ø–æ–ª–µ–π)
developers.sber.ru
.
python
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
# interface/buttons.py
from typing import List, Optional

class Button:
    def __init__(self, text: str, transition: Optional[str] = None):
        self.text = text
        self.transition = transition

    def to_dict(self):
        btn = {"text": self.text}
        if self.transition:
            btn["transition"] = self.transition
        return btn

class ButtonsBlock:
    def __init__(self, buttons: List[Button], state: Optional[str] = None):
        self.type = "buttons"
        self.buttons = buttons
        self.state = state

    def to_dict(self):
        data = {
            "type": self.type,
            "buttons": [btn.to_dict() for btn in self.buttons]
        }
        if self.state:
            data["state"] = self.state
        return data
main.py
–í main.py –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –∏ –ø—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞. –ó–∞–ø—É—Å–∫: –ø—Ä–æ—Å—Ç–æ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ python main.py –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏. –ö–æ–¥ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç Docker –∏ –≥–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É.
python
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
# main.py
from config.settings import SBER_CHAT_TOKEN, SBER_CHAT_URL, ADMIN_USER
from infrastructure.excel_storage import (
    KnowledgeBaseRepository, ChatHistoryRepository, FeedbackRepository, FullChatLogRepository
)
from infrastructure.sber_chat_client import SberChatClient
from application.use_cases import HandleMessageUseCase, HandleFeedbackUseCase
from interface.buttons import Button, ButtonsBlock

def main():
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ –°–±–µ—Ä–ß–∞—Ç–∞ –∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤
    chat_client = SberChatClient(SBER_CHAT_TOKEN, SBER_CHAT_URL)
    knowledge_repo = KnowledgeBaseRepository("knowledge_base.xlsx")
    chat_history_repo = ChatHistoryRepository("chat_history.xlsx")
    feedback_repo = FeedbackRepository("feedback_data.xlsx")
    full_log_repo = FullChatLogRepository("full_chat_log.xlsx")

    # Use cases
    msg_handler = HandleMessageUseCase(knowledge_repo, chat_history_repo, full_log_repo)
    fb_handler = HandleFeedbackUseCase(feedback_repo, full_log_repo, chat_client, ADMIN_USER)

    # –ü—Ä–∏–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
    user_id = "user123"
    incoming_text = "–ü—Ä–∏–≤–µ—Ç, –±–æ—Ç!"
    answer = msg_handler.execute(user_id, incoming_text)

    # –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏ üëç/üëé
    like_button = Button(text="üëç")
    dislike_button = Button(text="üëé")
    buttons_block = ButtonsBlock(buttons=[like_button, dislike_button])
    # –ù–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å buttons_block –≤ API, –∑–¥–µ—Å—å –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç
    chat_client.send_message(user_id, answer)
    print(f"–û—Ç–≤–µ—Ç –±–æ—Ç–∞: {answer} (–∫–Ω–æ–ø–∫–∏: üëç, üëé)")

    # –ü—Ä–∏–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∏–∑–ª–∞–π–∫–∞
    user_feedback = "dislike"
    fb_handler.execute(user_id, user_feedback)

if __name__ == "__main__":
    main()
Excel-—Ñ–∞–π–ª—ã:
knowledge_base.xlsx ‚Äì –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ª–∏—Å—Ç —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏ question –∏ answer –¥–ª—è –ø–æ–∏—Å–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤.
chat_history.xlsx ‚Äì —Ö—Ä–∞–Ω–∏—Ç question, answer, user_id –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞.
feedback_data.xlsx ‚Äì —Ö—Ä–∞–Ω–∏—Ç –æ—Ü–µ–Ω–∫–∏ (user_id, feedback, timestamp).
full_chat_log.xlsx ‚Äì —Ö—Ä–∞–Ω–∏—Ç –ø–æ–ª–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π (timestamp, user_id, message, is_bot).
admin_corrections.xlsx ‚Äì —Ñ–∞–π–ª –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –∞–¥–º–∏–Ω–∞ –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Å–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–æ–ª–æ–Ω–∫–∏ wrong_question, correct_answer), –Ω–æ –ª–æ–≥–∏–∫–∞ –µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∫–æ–¥–µ –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞.
–ö–∞–∂–¥—ã–π —Ñ–∞–π–ª —Å–æ–∑–¥–∞—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç (—Å –ø–æ–º–æ—â—å—é pandas –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è—Ö). –ù–∞–ø—Ä–∏–º–µ—Ä, KnowledgeBaseRepository —Å–æ–∑–¥–∞—ë—Ç –ø—É—Å—Ç–æ–π knowledge_base.xlsx —Å –Ω—É–∂–Ω—ã–º–∏ –∫–æ–ª–æ–Ω–∫–∞–º–∏. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ: –ü–æ–ª—É—á–µ–Ω–Ω—ã–π –ø—Ä–æ–µ–∫—Ç —Å—Ç—Ä–æ–≥–æ —Å–ª–µ–¥—É–µ—Ç –ø—Ä–∏–Ω—Ü–∏–ø–∞–º —á–∏—Å—Ç–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã, –≥–¥–µ —Å–ª–æ–∏ —Ä–∞–∑–¥–µ–ª–µ–Ω—ã –∏ —Å–ª–∞–±–æ —Å–≤—è–∑–∞–Ω—ã –¥—Ä—É–≥ —Å –¥—Ä—É–≥–æ–º
medium.com
medium.com
. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ—Ä—É—Ç—Å—è –∏–∑ .env
geeksforgeeks.org
, –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å SberChat –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–ª–∞—Å—Å-–∫–ª–∏–µ–Ω—Ç
developers.sber.ru
. –î–ª—è —Ä–∞–±–æ—Ç—ã —Å Excel –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ pandas
digitalocean.com
. –ü—Ä–æ–µ–∫—Ç –º–æ–∂–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤ —á–∏—Å—Ç–æ–º Python-–≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏, —É—Å—Ç–∞–Ω–æ–≤–∏–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (pandas, python-dotenv, requests), –ø–æ—Å–ª–µ —á–µ–≥–æ –±–æ—Ç –≥–æ—Ç–æ–≤ –∫ –ø—Ä–∏—ë–º—É —Å–æ–æ–±—â–µ–Ω–∏–π –∏ —Å–∞–º–æ–æ–±—É—á–µ–Ω–∏—é. –ò—Å—Ç–æ—á–Ω–∏–∫–∏: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø–∞–º Clean Architecture
medium.com
, –ø—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç—ã —Å Excel/pandas
digitalocean.com
, Python-–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è difflib.get_close_matches
docs.python.org
, —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ python-dotenv
geeksforgeeks.org
, —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è SberChat Chat API
developers.sber.ru
developers.sber.ru
.
